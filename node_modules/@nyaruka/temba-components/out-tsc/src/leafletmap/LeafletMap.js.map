{"version":3,"file":"LeafletMap.js","sourceRoot":"","sources":["../../../src/leafletmap/LeafletMap.ts"],"names":[],"mappings":"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","sourcesContent":["import { Feature, Geometry } from 'geojson';\nimport {\n  GeoJSON,\n  geoJSON,\n  LeafletEvent,\n  LeafletMouseEvent,\n  Map as RenderedMap,\n  map as createMap,\n  Path,\n} from 'leaflet';\nimport { css, html, LitElement } from 'lit';\nimport { property } from 'lit/decorators';\n\nimport { FeatureProperties } from '../interfaces';\nimport { getUrl, WebResponse } from '../utils';\nimport { highlightedFeature, normalFeature, visibleStyle } from './helpers';\n\nexport class LeafletMap extends LitElement {\n  static get styles() {\n    return css`\n      :host {\n        display: block;\n        padding: 0px;\n      }\n\n      #alias-map {\n        top: 0px;\n        height: 100%;\n      }\n\n      .leaflet-container {\n        background: transparent;\n      }\n\n      .path {\n        position: absolute;\n        color: #666;\n      }\n\n      .path > .step {\n        display: inline-block;\n        font-size: 12px;\n        margin-left: 5px;\n      }\n\n      .path > .step.hovered {\n        color: #999;\n      }\n\n      .path > .step.linked {\n        text-decoration: underline;\n        color: var(--color-link-primary);\n        cursor: pointer;\n      }\n    `;\n  }\n\n  @property()\n  feature: FeatureProperties;\n\n  @property()\n  osmId = '';\n\n  @property()\n  endpoint = '';\n\n  @property()\n  onFeatureClicked: (feature: FeatureProperties) => void;\n\n  @property()\n  hovered: FeatureProperties = null;\n\n  @property()\n  path: FeatureProperties[] = [];\n\n  renderedMap: RenderedMap = null;\n  states: GeoJSON<any> = null;\n\n  constructor() {\n    super();\n  }\n\n  private getRenderRoot(): DocumentFragment {\n    return this.renderRoot as DocumentFragment;\n  }\n\n  private getEndpoint(): string {\n    return this.endpoint + (!this.endpoint.endsWith('/') ? '/' : '');\n  }\n\n  paths: { [osmId: string]: Path } = {};\n  lastHovered: Path = null;\n\n  private refreshMap(): void {\n    const onEachFeature = (feature: Feature<Geometry, any>, path: Path) => {\n      this.paths[feature.properties.osm_id] = path;\n\n      path.on({\n        click: (event: LeafletMouseEvent) => {\n          const feature: FeatureProperties = event.target.feature.properties;\n          if (feature.osm_id !== this.path[this.path.length - 1].osm_id) {\n            const orig = event.originalEvent;\n\n            orig.stopPropagation();\n            orig.preventDefault();\n\n            if (this.onFeatureClicked) {\n              this.onFeatureClicked(feature);\n            }\n\n            this.hovered = null;\n            this.path.push(feature);\n            this.osmId = feature.osm_id;\n            this.refreshMap();\n          }\n        },\n        mouseover: (event: LeafletEvent) => {\n          const feature: FeatureProperties = event.target.feature.properties;\n          if (feature.osm_id !== this.path[this.path.length - 1].osm_id) {\n            event.target.setStyle(highlightedFeature);\n            this.hovered = feature;\n          }\n        },\n        mouseout: (event: LeafletEvent) => {\n          event.target.setStyle(normalFeature);\n          this.hovered = null;\n        },\n      });\n    };\n\n    getUrl(this.getEndpoint() + 'geometry/' + this.osmId + '/').then(\n      (response: WebResponse) => {\n        if (this.states) {\n          this.renderedMap.removeLayer(this.states);\n        }\n\n        const data = response.json;\n        if (this.path.length === 0) {\n          this.path = [\n            {\n              name: data.name,\n              osm_id: this.osmId,\n              level: 0,\n            },\n          ];\n        }\n\n        this.states = geoJSON(data.geometry, {\n          style: visibleStyle,\n          onEachFeature,\n        });\n        this.renderedMap.fitBounds(this.states.getBounds(), {});\n        this.states.addTo(this.renderedMap);\n      }\n    );\n  }\n\n  public updated(changedProperties: Map<string, any>) {\n    if (changedProperties.has('hovered')) {\n      if (this.lastHovered) {\n        this.lastHovered.setStyle(normalFeature);\n      }\n\n      if (this.hovered) {\n        const layer = this.paths[this.hovered.osm_id];\n        this.lastHovered = layer;\n        if (layer) {\n          layer.setStyle(highlightedFeature);\n        }\n      }\n    }\n\n    if (changedProperties.has('feature') && this.feature) {\n      this.hovered = null;\n      if (\n        this.path.length === 0 ||\n        this.path[this.path.length - 1].osm_id !== this.feature.osm_id\n      ) {\n        this.path.push(this.feature);\n      }\n    }\n\n    if (changedProperties.has('osmId')) {\n      const path: FeatureProperties[] = [];\n      for (const feature of this.path) {\n        path.push(feature);\n        if (feature.osm_id === this.osmId) {\n          if (this.onFeatureClicked) {\n            this.onFeatureClicked(feature);\n          }\n          break;\n        }\n      }\n\n      this.path = path;\n\n      this.refreshMap();\n    }\n  }\n\n  public firstUpdated(changedProperties: any) {\n    const mapElement = this.getRenderRoot().getElementById('alias-map');\n    this.renderedMap = createMap(mapElement, {\n      attributionControl: false,\n      scrollWheelZoom: false,\n      zoomControl: false,\n    }).setView([0, 1], 4);\n    this.renderedMap.dragging.disable();\n    this.renderedMap.doubleClickZoom.disable();\n\n    this.refreshMap();\n    super.firstUpdated(changedProperties);\n  }\n\n  private handleClickedBreadcrumb(e: MouseEvent): void {\n    this.osmId = (e.currentTarget as HTMLElement).getAttribute('data-osmid');\n    const path: FeatureProperties[] = [];\n    for (const feature of this.path) {\n      path.push(feature);\n      if (feature.osm_id === this.osmId) {\n        if (this.onFeatureClicked) {\n          this.onFeatureClicked(feature);\n        }\n        break;\n      }\n    }\n\n    this.path = path;\n    this.refreshMap();\n  }\n\n  render() {\n    if (!this.osmId) {\n      return html`<div>No osm map id</div>`;\n    }\n\n    return html`\n      <link\n        rel=\"stylesheet\"\n        href=\"https://unpkg.com/leaflet@1.5.1/dist/leaflet.css\"\n      />\n      <div id=\"alias-map\"></div>\n    `;\n  }\n}\n"]}